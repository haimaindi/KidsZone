import React, { useState, useRef, useEffect } from 'react';
import { 
  Pencil, 
  Eraser, 
  RotateCcw, 
  Sparkles, 
  Download, 
  X, 
  Check, 
  Monitor, 
  Smartphone,
  Maximize2, 
  Upload, 
  Briefcase, 
  ChevronLeft, 
  Heart, 
  User, 
  Image as ImageIcon, 
  Timer, 
  Baby, 
  BookOpen, 
  Send, 
  ChevronRight, 
  Loader2, 
  Printer, 
  PawPrint, 
  Leaf, 
  Car, 
  Mountain, 
  Volume2, 
  Type,
  Utensils,
  Rocket,
  Music,
  Truck,
  Speaker,
  Mic2,
  Languages,
  Tags,
  SpellCheck,
  Play,
  Camera,
  Square
} from 'lucide-react';

// --- Konfigurasi AI ---
const apiKey = ""; 

// --- Magic Sketch Presets ---
const PRESETS_SKETCH = [
  { id: 'cartoon', name: 'Kartun Lucu', icon: 'ğŸ¨', prompt: 'vibrant 3D Disney-style animation illustration' },
  { id: 'realism', name: 'Dunia Nyata', icon: 'ğŸ“¸', prompt: 'realistic, highly detailed photographic professional style' },
  { id: 'anime', name: 'Pahlawan Anime', icon: 'ğŸŒ', prompt: 'beautiful Studio Ghibli style anime painting' },
  { id: 'watercolor', name: 'Cat Air', icon: 'ğŸ–Œï¸', prompt: 'soft, artistic hand-painted watercolor masterpiece' }
];

// --- If I Becomes Presets ---
const JOBS = [
  { id: 'astronaut', name: 'Astronot', icon: 'ğŸš€', prompt: 'a brave astronaut in a high-tech space suit, standing on the moon with stars and earth in the background' },
  { id: 'doctor', name: 'Dokter', icon: 'ğŸ©º', prompt: 'a kind professional doctor wearing a white lab coat with a semicolon, in a modern hospital office' },
  { id: 'firefighter', name: 'Pemadam Kebakaran', icon: 'ğŸš’', prompt: 'a heroic firefighter in protective gear standing next to a big fire truck' },
  { id: 'chef', name: 'Koki Handal', icon: 'ğŸ‘¨â€ğŸ³', prompt: 'a professional master chef in a clean white kitchen with delicious food' },
  { id: 'pilot', name: 'Pilot Pesawat', icon: 'âœˆï¸', prompt: 'a cool airplane pilot in uniform inside a high-tech cockpit' },
  { id: 'scientist', name: 'Ilmuwan', icon: 'ğŸ§ª', prompt: 'a brilliant scientist in a chemistry lab with colorful potions and a microscope' },
  { id: 'policeman', name: 'Polisi', icon: 'ğŸ‘®', prompt: 'a brave police officer in uniform standing in front of a police car' },
  { id: 'artist', name: 'Pelukis', icon: 'ğŸ¨', prompt: 'a creative artist in an art studio surrounded by colorful canvases and paintings' }
];

// --- Printable Sketch Presets ---
const PRINTABLE_CATEGORIES = [
  { id: 'animals', name: 'Hewan', icon: <PawPrint size={20} />, color: 'text-orange-500', bg: 'bg-orange-50', items: [{ name: 'Gajah', icon: 'ğŸ˜' }, { name: 'Harimau', icon: 'ğŸ¯' }, { name: 'Ikan', icon: 'ğŸ ' }, { name: 'Kucing', icon: 'ğŸ±' }, { name: 'Kupu-kupu', icon: 'ğŸ¦‹' }, { name: 'Jerapah', icon: 'ğŸ¦’' }] },
  { id: 'plants', name: 'Tumbuhan', icon: <Leaf size={20} />, color: 'text-green-500', bg: 'bg-green-50', items: [{ name: 'Pohon Pinus', icon: 'ğŸŒ²' }, { name: 'Buah Apel', icon: 'ğŸ' }, { name: 'Bunga Matahari', icon: 'ğŸŒ»' }, { name: 'Hutan Rimba', icon: 'ğŸŒ³' }, { name: 'Kebun Mawar', icon: 'ğŸŒ¹' }] },
  { id: 'transport', name: 'Transportasi', icon: <Car size={20} />, color: 'text-blue-500', bg: 'bg-blue-50', items: [{ name: 'Mobil Balap', icon: 'ğŸï¸' }, { name: 'Pesawat Terbang', icon: 'âœˆï¸' }, { name: 'Kapal Pesiar', icon: 'ğŸš¢' }, { name: 'Kereta Api', icon: 'ğŸš‚' }, { name: 'Roket', icon: 'ğŸš€' }] },
  { id: 'nature', name: 'Alam', icon: <Mountain size={20} />, color: 'text-cyan-500', bg: 'bg-cyan-50', items: [{ name: 'Gunung Berapi', icon: 'ğŸŒ‹' }, { name: 'Pantai', icon: 'ğŸ–ï¸' }, { name: 'Sawah', icon: 'ğŸŒ¾' }, { name: 'Air Terjun', icon: 'ğŸŒŠ' }, { name: 'Bulan & Bintang', icon: 'ğŸŒ™' }] }
];

// --- Learn The Thing Themes ---
const LEARN_THEMES = [
  { id: 'animals', name: 'Dunia Hewan', icon: <PawPrint />, color: 'text-orange-500', bg: 'bg-orange-50' },
  { id: 'food', name: 'Makanan Lezat', icon: <Utensils />, color: 'text-pink-500', bg: 'bg-pink-50' },
  { id: 'space', name: 'Luar Angkasa', icon: <Rocket />, color: 'text-indigo-500', bg: 'bg-indigo-50' },
  { id: 'nature', name: 'Alam Raya', icon: <Mountain />, color: 'text-emerald-500', bg: 'bg-emerald-50' }
];

// --- Sound Explorer Themes ---
const SOUND_THEMES = [
  { id: 'animals', name: 'Hewan Lucu', icon: <PawPrint />, color: 'text-orange-500', bg: 'bg-orange-50' },
  { id: 'vehicles', name: 'Kendaraan', icon: <Truck />, color: 'text-blue-500', bg: 'bg-blue-50' },
  { id: 'music', name: 'Alat Musik', icon: <Music />, color: 'text-purple-500', bg: 'bg-purple-50' },
  { id: 'nature_sounds', name: 'Suara Alam', icon: <Mountain />, color: 'text-emerald-500', bg: 'bg-emerald-50' }
];

const ALPHABET_LIST = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");

const COLORS = ['#FF595E', '#FFCA3A', '#8AC926', '#1982C4', '#6A4C93', '#FF924C', '#FFFFFF', '#000000'];

// --- Helper Functions ---
const pcmToWav = (pcmData, sampleRate) => {
  const buffer = new ArrayBuffer(44 + pcmData.length * 2);
  const view = new DataView(buffer);
  const writeString = (offset, string) => {
    for (let i = 0; i < string.length; i++) {
      view.setUint8(offset + i, string.charCodeAt(i));
    }
  };
  writeString(0, 'RIFF');
  view.setUint32(4, 32 + pcmData.length * 2, true);
  writeString(8, 'WAVE');
  writeString(12, 'fmt ');
  view.setUint32(16, 16, true);
  view.setUint16(20, 1, true);
  view.setUint16(22, 1, true);
  view.setUint32(24, sampleRate, true);
  view.setUint32(28, sampleRate * 2, true);
  view.setUint16(32, 2, true);
  view.setUint16(34, 16, true);
  writeString(36, 'data');
  view.setUint32(40, pcmData.length * 2, true);
  let offset = 44;
  for (let i = 0; i < pcmData.length; i++, offset += 2) {
    view.setInt16(offset, pcmData[i], true);
  }
  return new Blob([buffer], { type: 'audio/wav' });
};

const fetchWithRetry = async (url, options, retries = 5, backoff = 1000) => {
  try {
    const response = await fetch(url, options);
    const data = await response.json();
    if (!response.ok) throw new Error(data.error?.message || `HTTP error! status: ${response.status}`);
    return data;
  } catch (error) {
    if (retries > 0) {
      await new Promise(resolve => setTimeout(resolve, backoff));
      return fetchWithRetry(url, options, retries - 1, backoff * 2);
    }
    throw error;
  }
};

const MenuCard = ({ onClick, icon, title, desc, color }) => {
  const colors = {
    blue: 'hover:border-[#1982C4] shadow-blue-100',
    red: 'hover:border-[#FF595E] shadow-red-100',
    green: 'hover:border-[#8AC926] shadow-green-100',
    yellow: 'hover:border-[#FFCA3A] shadow-yellow-100',
    purple: 'hover:border-[#9B5DE5] shadow-purple-100',
    cyan: 'hover:border-[#00BBF9] shadow-cyan-100'
  };
  return (
    <button onClick={onClick} className={`group bg-white p-6 rounded-[3rem] shadow-xl hover:shadow-2xl hover:-translate-y-2 transition-all border-8 border-transparent text-left ${colors[color]}`}>
      <div className="bg-gray-50 w-14 h-14 rounded-2xl flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">{icon}</div>
      <h2 className="text-2xl font-black text-[#2D3142] mb-1 leading-none">{title}</h2>
      <p className="text-gray-500 font-medium leading-tight text-sm">{desc}</p>
    </button>
  );
};

const MainMenu = ({ setView }) => (
  <div className="min-h-screen bg-[#F0F7FF] flex flex-col items-center justify-center p-6 font-['Fredoka_One',_cursive]">
    <div className="text-center mb-10 animate-in fade-in zoom-in">
      <div className="w-24 h-24 bg-yellow-400 rounded-[2rem] flex items-center justify-center shadow-2xl mx-auto mb-6 rotate-6">
        <Sparkles className="text-white w-14 h-14" />
      </div>
      <h1 className="text-6xl font-black text-[#1982C4] mb-2 leading-none">KidsZone</h1>
      <p className="text-xl text-gray-500 font-bold uppercase tracking-widest leading-none">Creative Lab</p>
    </div>
    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 w-full max-w-7xl">
      <MenuCard onClick={() => setView('sketch')} icon={<Pencil className="text-[#1982C4]" />} title="Magic Sketch" desc="Coretan jadi lukisan ajaib!" color="blue" />
      <MenuCard onClick={() => setView('ifibecomes')} icon={<Briefcase className="text-[#FF595E]" />} title="If I Becomes" desc="Lihat dirimu di masa depan!" color="red" />
      <MenuCard onClick={() => setView('story')} icon={<BookOpen className="text-[#8AC926]" />} title="Story Maker" desc="Buat buku ceritamu sendiri!" color="green" />
      <MenuCard onClick={() => setView('printable')} icon={<Printer className="text-[#FFCA3A]" />} title="Printable Sketch" desc="Cetak sketsa mewarnai favorit!" color="yellow" />
      <MenuCard onClick={() => setView('learn')} icon={<Type className="text-[#9B5DE5]" />} title="Learn The Thing" desc="Belajar alfabet interaktif!" color="purple" />
      <MenuCard onClick={() => setView('sound')} icon={<Speaker className="text-[#00BBF9]" />} title="Sound Explorer" desc="Jelajahi berbagai suara unik!" color="cyan" />
    </div>
  </div>
);

const App = () => {
  const [view, setView] = useState('menu'); 
  const [showModal, setShowModal] = useState(false);
  const [modalImage, setModalImage] = useState(null);
  const [modalType, setModalType] = useState(null); 
  const [error, setError] = useState(null);

  // --- Global State for Audio Prefetch ---
  const [audioCache, setAudioCache] = useState({}); // { [key]: blobUrl }

  // --- Magic Sketch State ---
  const [sketchStep, setSketchStep] = useState('draw'); 
  const [orientation, setOrientation] = useState('landscape'); 
  const [activeTool, setActiveTool] = useState('pencil');
  const [activeColor, setActiveColor] = useState('#FF595E');
  const [brushSize, setBrushSize] = useState(10);
  const [selectedSketchPreset, setSelectedSketchPreset] = useState(PRESETS_SKETCH[0]);
  const [isProcessingSketch, setIsProcessingSketch] = useState(false);
  const [sketchResult, setSketchResult] = useState(null);
  const [sketchNarration, setSketchNarration] = useState("");
  const [originalSketch, setOriginalSketch] = useState(null);

  // --- If I Becomes State ---
  const [uploadedPhoto, setUploadedPhoto] = useState(null);
  const [selectedJob, setSelectedJob] = useState(JOBS[0]);
  const [customJob, setCustomJob] = useState("");
  const [isProcessingJobs, setIsProcessingJobs] = useState(false);
  const [jobResults, setJobResults] = useState([]); 
  const [isFuturePrediction, setIsFuturePrediction] = useState(false);

  // --- Story Maker State ---
  const [storyIdea, setStoryIdea] = useState("");
  const [isProcessingStory, setIsProcessingStory] = useState(false);
  const [storyPages, setStoryPages] = useState([]); 
  const [currentStoryIdx, setCurrentStoryIdx] = useState(0);
  const [storyLanguage, setStoryLanguage] = useState('id');
  const [storyPhoto, setStoryPhoto] = useState(null);

  // --- Printable Sketch State ---
  const [printableCategory, setPrintableCategory] = useState(PRINTABLE_CATEGORIES[0]);
  const [printableSubject, setPrintableSubject] = useState(PRINTABLE_CATEGORIES[0].items[0].name);
  const [customPrintable, setCustomPrintable] = useState("");
  const [isProcessingPrintable, setIsProcessingPrintable] = useState(false);
  const [printableResults, setPrintableResults] = useState([]);

  // --- Learn The Thing State ---
  const [learnStep, setLearnStep] = useState('setup'); 
  const [learnLanguage, setLearnLanguage] = useState('id'); 
  const [learnMode, setLearnMode] = useState('theme'); 
  const [selectedLearnTheme, setSelectedLearnTheme] = useState(LEARN_THEMES[0]);
  const [selectedLearnLetter, setSelectedLearnLetter] = useState('A');
  const [customLearnTheme, setCustomLearnTheme] = useState("");
  const [learnItems, setLearnItems] = useState([]); 
  const [isSpeaking, setIsSpeaking] = useState(false);
  const [selectedLetterItem, setSelectedLetterItem] = useState(null);

  // --- Sound Explorer State ---
  const [soundStep, setSoundStep] = useState('setup'); 
  const [selectedSoundTheme, setSelectedSoundTheme] = useState(SOUND_THEMES[0]);
  const [customSoundTheme, setCustomSoundTheme] = useState("");
  const [soundItems, setSoundItems] = useState([]); 
  const [selectedSoundItem, setSelectedSoundItem] = useState(null);

  // --- Refs ---
  const canvasRef = useRef(null);
  const contextRef = useRef(null);
  const isDrawing = useRef(false);
  const currentAudioRef = useRef(null);

  // --- Universal Audio Handlers ---
  const stopCurrentAudio = () => {
    if (currentAudioRef.current) {
      currentAudioRef.current.pause();
      currentAudioRef.current = null;
    }
    setIsSpeaking(false);
  };

  const getTTSBlob = async (text, langCode = 'id') => {
    const speakerVoice = langCode === 'id' ? 'Kore' : 'Zephyr';
    const emotionPrefix = langCode === 'id' ? 'Katakan dengan ceria: ' : 'Say cheerfully: ';
    try {
      const data = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ parts: [{ text: emotionPrefix + text }] }], generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: speakerVoice } } } } })
      });
      const pcmBase64 = data.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
      const sampleRate = parseInt(data.candidates?.[0]?.content?.parts?.[0]?.inlineData?.mimeType.split('rate=')[1] || "24000");
      if (pcmBase64) {
        const binaryString = window.atob(pcmBase64);
        const pcmData = new Int16Array(binaryString.length / 2);
        for (let i = 0; i < pcmData.length; i++) { pcmData[i] = binaryString.charCodeAt(i * 2) | (binaryString.charCodeAt(i * 2 + 1) << 8); }
        const wavBlob = pcmToWav(pcmData, sampleRate);
        return URL.createObjectURL(wavBlob);
      }
    } catch (err) { console.error("TTS generation error", err); }
    return null;
  };

  const playAudio = async (text, idKey, langCode = 'id') => {
    if (isSpeaking) { stopCurrentAudio(); return; }
    
    let audioUrl = audioCache[idKey];
    if (!audioUrl) {
      audioUrl = await getTTSBlob(text, langCode);
      if (audioUrl) setAudioCache(prev => ({ ...prev, [idKey]: audioUrl }));
    }

    if (audioUrl) {
      const audio = new Audio(audioUrl);
      currentAudioRef.current = audio;
      setIsSpeaking(true);
      audio.onended = () => setIsSpeaking(false);
      audio.play();
    }
  };

  // --- Handlers & Helpers ---
  const handleDownloadSimple = (imageUrl, fileName = "kidszone_artwork.png") => {
    const link = document.createElement('a');
    link.href = imageUrl;
    link.download = fileName;
    link.click();
  };

  const downloadMagicResultWithSnapshot = (resultUrl, originalUrl) => {
    const resultImg = new Image();
    resultImg.crossOrigin = "anonymous";
    resultImg.src = resultUrl;
    resultImg.onload = () => {
      const canvas = document.createElement('canvas');
      canvas.width = resultImg.width;
      canvas.height = resultImg.height;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(resultImg, 0, 0);

      const originalImg = new Image();
      originalImg.src = originalUrl;
      originalImg.onload = () => {
        const snapSize = canvas.width * 0.18; 
        const padding = 30;
        const x = canvas.width - snapSize - padding;
        const y = canvas.height - snapSize - padding;
        ctx.fillStyle = "white";
        ctx.beginPath();
        ctx.roundRect(x - 5, y - 5, snapSize + 10, snapSize + 10, 15);
        ctx.fill();
        ctx.drawImage(originalImg, x, y, snapSize, snapSize);
        const link = document.createElement('a');
        link.download = `MagicSketch_Result.png`;
        link.href = canvas.toDataURL("image/png");
        link.click();
      };
    };
  };

  const download34Portrait = (imageUrl, prefix = "KidsZone", idx = 0) => {
    const img = new Image(); img.crossOrigin = "anonymous"; img.src = imageUrl;
    img.onload = () => {
      const canvas = document.createElement('canvas'); canvas.width = 1200; canvas.height = 1600;
      const ctx = canvas.getContext('2d');
      const targetRatio = 1200 / 1600;
      const imgRatio = img.width / img.height;
      let dWidth, dHeight, dx, dy;
      if (imgRatio > targetRatio) { 
        dHeight = 1600; dWidth = 1600 * imgRatio;
        dx = (1200 - dWidth) / 2; dy = 0;
      } else { 
        dWidth = 1200; dHeight = 1200 / imgRatio;
        dx = 0; dy = (1600 - dHeight) / 2;
      }
      ctx.fillStyle = "white";
      ctx.fillRect(0, 0, 1200, 1600);
      ctx.drawImage(img, dx, dy, dWidth, dHeight);
      const link = document.createElement('a'); link.download = `${prefix}_${idx + 1}.png`; link.href = canvas.toDataURL("image/png"); link.click();
    };
  };

  const downloadA4Printable = (imageUrl, idx = 0) => {
    const img = new Image(); img.crossOrigin = "anonymous"; img.src = imageUrl;
    img.onload = () => {
      const canvas = document.createElement('canvas'); canvas.width = 3508; canvas.height = 2480;
      const ctx = canvas.getContext('2d'); ctx.fillStyle = "white"; ctx.fillRect(0, 0, canvas.width, canvas.height);
      const imgRatio = img.width / img.height; const canvasRatio = 3508 / 2480;
      let dWidth, dHeight, dx, dy;
      if (imgRatio > canvasRatio) { dWidth = 3508; dHeight = 3508 / imgRatio; } 
      else { dHeight = 2480; dWidth = 2480 * imgRatio; }
      dx = (3508 - dWidth) / 2; dy = (2480 - dHeight) / 2;
      ctx.drawImage(img, dx, dy, dWidth, dHeight);
      const link = document.createElement('a'); link.download = `Cetak_Mewarnai_A4_${idx + 1}.png`; link.href = canvas.toDataURL("image/png"); link.click();
    };
  };

  const handleFileUpload = (e, type = 'job') => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader(); 
      reader.onload = (f) => {
        if (type === 'job') setUploadedPhoto(f.target.result);
        else if (type === 'story') setStoryPhoto(f.target.result);
      }; 
      reader.readAsDataURL(file);
    }
  };

  const compositeTextOnImage = (imgSrc, text, pageNum) => {
    return new Promise((resolve) => {
      const img = new Image(); img.src = imgSrc;
      img.onload = () => {
        const canvas = document.createElement('canvas'); canvas.width = 1280; canvas.height = 720;
        const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        const margin = 30; const padding = 15; const maxWidth = canvas.width - (margin * 2) - (padding * 2);
        let fontSize = 24; ctx.font = `bold ${fontSize}px Fredoka One, Arial`;
        const wrapText = (txt, fSize) => {
          ctx.font = `bold ${fSize}px Fredoka One, Arial`;
          const words = txt.split(' '); let lines = []; let currentLine = words[0];
          for (let i = 1; i < words.length; i++) {
            const word = words[i]; const width = ctx.measureText(currentLine + " " + word).width;
            if (width < maxWidth) { currentLine += " " + word; } else { lines.push(currentLine); currentLine = word; }
          }
          lines.push(currentLine); return lines;
        };
        let storyLines = wrapText(text, fontSize);
        while (storyLines.length > 3 && fontSize > 16) { fontSize -= 2; storyLines = wrapText(text, fontSize); }
        const lineHeight = fontSize * 1.3; const boxHeight = (storyLines.length * lineHeight) + (padding * 2); const boxY = canvas.height - boxHeight - margin;
        ctx.fillStyle = 'rgba(255, 255, 255, 0.9)'; ctx.beginPath(); ctx.roundRect(margin, boxY, canvas.width - (margin * 2), boxHeight, 20); ctx.fill();
        ctx.fillStyle = '#1982C4'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
        storyLines.forEach((line, i) => { const lineY = boxY + padding + (i * lineHeight) + (lineHeight / 2); ctx.fillText(line, canvas.width / 2, lineY); });
        const tagW = 80; const tagH = 30; ctx.fillStyle = '#FF595E'; ctx.beginPath(); ctx.roundRect(canvas.width - margin - tagW, boxY - tagH/2, tagW, tagH, 10); ctx.fill();
        ctx.fillStyle = 'white'; ctx.font = 'bold 16px Arial'; ctx.fillText(`${pageNum}/12`, canvas.width - margin - tagW/2, boxY);
        resolve(canvas.toDataURL('image/png'));
      };
    });
  };

  const createStory = async () => {
    if (!storyIdea.trim()) return;
    setIsProcessingStory(true); setStoryPages([]); setError(null);
    try {
      const initialPrompt = `Act as a Storyboard Director. Create a kid-friendly story: "${storyIdea}". ${storyPhoto ? "Protagonist looks like the child in photo. " : ""}Break story into EXACTLY 12 stories. Provide storyText and imagePrompt as JSON: { "scenes": [{ "storyText": "...", "imagePrompt": "..." }] }. Language: ${storyLanguage === 'id' ? 'Indonesian' : 'English'}.`;
      const initialContents = [{ parts: [{ text: initialPrompt }] }];
      if (storyPhoto) initialContents[0].parts.push({ inlineData: { mimeType: "image/png", data: storyPhoto.split(',')[1] } });
      
      const data = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: initialContents, generationConfig: { responseMimeType: "application/json" } })
      });
      
      const storyboardData = JSON.parse(data.candidates[0].content.parts[0].text);
      const generatedPages = [];
      for (let i = 0; i < storyboardData.scenes.length; i++) {
        const page = storyboardData.scenes[i];
        const imgParts = [{ text: `Vibrant 3D Pixar style. Scene ${i+1}: ${page.imagePrompt}. NO TEXT in image. 16:9 widescreen.` }];
        if (storyPhoto) imgParts.push({ inlineData: { mimeType: "image/png", data: storyPhoto.split(',')[1] } });
        
        const imgData = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ contents: [{ parts: imgParts }], generationConfig: { responseModalities: ['TEXT', 'IMAGE'] } })
        });
        
        const rawBase64 = imgData.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
        if (rawBase64) {
          const comp = await compositeTextOnImage(`data:image/png;base64,${rawBase64}`, page.storyText, i + 1);
          generatedPages.push({ image: comp, text: page.storyText, audioKey: `story_${i}` });
          setStoryPages([...generatedPages]);
          // Prefetch audio for this page
          getTTSBlob(page.storyText, storyLanguage).then(url => {
            if (url) setAudioCache(prev => ({ ...prev, [`story_${i}`]: url }));
          });
        }
      }
    } catch (err) { setError("Ups! Sihir cerita macet."); }
    setIsProcessingStory(false);
  };

  const generatePrintableSketches = async () => {
    const subject = customPrintable.trim() || printableSubject;
    setIsProcessingPrintable(true); setPrintableResults([]); setError(null);
    try {
      const finalPrompt = `Professional bold black and white line art coloring book page for kids. Subject: ${subject}. Clear thick outlines, no colors, pure white background, landscape 16:9.`;
      const requests = Array(4).fill(null).map(() => 
        fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ instances: { prompt: finalPrompt }, parameters: { sampleCount: 1 } })
        })
      );
      const responses = await Promise.all(requests);
      const images = responses.map(res => res.predictions?.[0]?.bytesBase64Encoded).filter(b => b).map(b => `data:image/png;base64,${b}`);
      if (images.length === 4) setPrintableResults(images);
      else throw new Error();
    } catch (err) { 
      try {
        const requests = Array(4).fill(null).map(() => 
          fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: `Coloring book line art, kids style: ${subject}. 16:9 landscape.` }] }], generationConfig: { responseModalities: ['TEXT', 'IMAGE'] } })
          })
        );
        const resps = await Promise.all(requests);
        setPrintableResults(resps.map(r => `data:image/png;base64,${r.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data}`).filter(b => b.length > 50));
      } catch (e) { setError("Gagal membuat sketsa."); }
    } finally { setIsProcessingPrintable(false); }
  };

  const startLearnTheThing = async () => {
    const lang = learnLanguage === 'id' ? 'Bahasa Indonesia' : 'English';
    let prompt = learnMode === 'theme' 
      ? `Provide 26 words (A-Z) in ${lang} for kids about "${customLearnTheme || selectedLearnTheme.name}". Respond JSON: [{"char": "A", "word": "...", "visualDescription": "High-fidelity 3D Pixar model of word, white background"}]`
      : `Provide 9 words in ${lang} starting with "${selectedLearnLetter}". Respond JSON: [{"char": "${selectedLearnLetter}", "word": "...", "visualDescription": "High-fidelity 3D Pixar model of word, white background"}]`;
    
    setLearnStep('generating'); setLearnItems([]); setError(null);
    try {
      const data = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } })
      });
      const list = JSON.parse(data.candidates[0].content.parts[0].text);
      setLearnItems(list.map(item => ({ ...item, imageUrl: null })));
      
      const updated = [...list];
      for (let i = 0; i < list.length; i++) {
        const item = list[i];
        fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ contents: [{ parts: [{ text: `Cute isolated 3D Pixar illustration: ${item.visualDescription}. PURE WHITE BACKGROUND. NO TEXT.` }] }], generationConfig: { responseModalities: ['TEXT', 'IMAGE'] } })
        }).then(imgRes => {
          const b64 = imgRes.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
          if (b64) {
            updated[i].imageUrl = `data:image/png;base64,${b64}`;
            setLearnItems([...updated]);
            const ttsTxt = `${item.char} ${learnLanguage === 'id' ? 'untuk' : 'is for'} ${item.word}`;
            getTTSBlob(ttsTxt, learnLanguage).then(url => {
              if (url) setAudioCache(prev => ({ ...prev, [`learn_${i}`]: url }));
            });
          }
        });
      }
      setLearnStep('result');
    } catch (err) { setError("Gagal memuat materi."); setLearnStep('setup'); }
  };

  const startSoundExplorer = async () => {
    const theme = customSoundTheme || selectedSoundTheme.name;
    const prompt = `List exactly 6 items with distinct sounds for theme: "${theme}". JSON: [{"name": "...", "onomatopoeia": "...", "visualAnchor": "High quality 3D model, white background"}]`;
    setSoundStep('generating'); setSoundItems([]); setError(null);
    try {
      const data = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } })
      });
      const list = JSON.parse(data.candidates[0].content.parts[0].text);
      setSoundItems(list.map(item => ({ ...item, imageUrl: null })));
      
      const updated = [...list];
      for (let i = 0; i < list.length; i++) {
        const item = list[i];
        fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ contents: [{ parts: [{ text: `Isolated high-fidelity 3D Pixar illustration: ${item.visualAnchor}. PURE WHITE BACKGROUND. NO TEXT.` }] }], generationConfig: { responseModalities: ['TEXT', 'IMAGE'] } })
        }).then(imgRes => {
          const b64 = imgRes.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
          if (b64) {
            updated[i].imageUrl = `data:image/png;base64,${b64}`;
            setSoundItems([...updated]);
            const ttsTxt = `${item.onomatopoeia}, itu adalah suara ${item.name}`;
            getTTSBlob(ttsTxt, 'id').then(url => {
              if (url) setAudioCache(prev => ({ ...prev, [`sound_${i}`]: url }));
            });
          }
        });
      }
      setSoundStep('result');
    } catch (err) { setError("Gagal memuat materi."); setSoundStep('setup'); }
  };

  const generateJobImages = async () => {
    if (!uploadedPhoto) return;
    setIsProcessingJobs(true); setJobResults([]); setError(null);
    const variations = [
      "standing confidently with a warm smile, professional lighting",
      "sitting naturally at a desk, looking directly at camera",
      "caught in a moment of professional action, heroic pose",
      "side profile view, cinematic portrait, high fidelity"
    ];
    try {
      const requests = variations.map(pose => {
        const agePrompt = isFuturePrediction 
          ? "MANDATORY: Mature young adult (22 years old), adjusted jawline and facial structure. " 
          : "STRICT: Keep child face EXACTLY as reference. 100% child face identity match. ";
        const finalPrompt = `Hyper-realistic photographic studio portrait. ${agePrompt} Dressed as ${customJob || selectedJob.prompt}. Pose: ${pose}. Photorealistic high-fidelity 3:4 portrait.`;
        return fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ contents: [{ parts: [{ text: finalPrompt }, { inlineData: { mimeType: "image/png", data: uploadedPhoto.split(',')[1] } }] }], generationConfig: { responseModalities: ['TEXT', 'IMAGE'] } })
        });
      });
      const resps = await Promise.all(requests);
      setJobResults(resps.map(r => `data:image/png;base64,${r.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data}`).filter(b => b.length > 50));
    } catch (err) { setError("Gagal membuat foto."); }
    setIsProcessingJobs(false);
  };

  const handleStartSketchMagic = async () => {
    setIsProcessingSketch(true); setSketchResult(null); setSketchNarration(""); setError(null);
    try {
      const robustPrompt = `Advanced Artistic Transformation. Maintain spatial outlines of the user's sketch. Realize it as a ${selectedSketchPreset.prompt}. HIGH FIDELITY integrity of the user's core strokes.`;
      const transData = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ parts: [{ text: robustPrompt }, { inlineData: { mimeType: "image/png", data: canvasRef.current.toDataURL().split(',')[1] } }] }], generationConfig: { responseModalities: ['TEXT', 'IMAGE'] } })
      });
      const b64 = transData.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
      if (b64) {
        setSketchResult(`data:image/png;base64,${b64}`);
        const narData = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ contents: [{ parts: [{ text: "Provide a VERY SHORT imaginative 1-2 sentence narration in Indonesian for this magic sketch result." }, { inlineData: { mimeType: "image/png", data: b64 } }] }] })
        });
        const narText = narData.candidates?.[0]?.content?.parts?.[0]?.text;
        if (narText) { 
          setSketchNarration(narText); 
          getTTSBlob(narText, 'id').then(url => {
            if (url) setAudioCache(prev => ({ ...prev, 'magic_sketch': url }));
          });
        }
      }
    } catch (err) { setError("Gagal menyulap coretan."); }
    setIsProcessingSketch(false);
  };

  useEffect(() => { if (view === 'sketch' && sketchStep === 'draw') setTimeout(initCanvas, 150); }, [view, sketchStep]);

  const initCanvas = () => {
    const canvas = canvasRef.current; if (!canvas) return;
    const rect = canvas.parentElement.getBoundingClientRect();
    canvas.width = rect.width; canvas.height = rect.height;
    const ctx = canvas.getContext('2d'); ctx.lineCap = 'round'; ctx.lineJoin = 'round'; ctx.fillStyle = 'white'; ctx.fillRect(0, 0, canvas.width, canvas.height);
    contextRef.current = ctx;
  };

  const startDrawing = (e) => {
    isDrawing.current = true; const rect = canvasRef.current.getBoundingClientRect();
    const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left; const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
    contextRef.current.beginPath(); contextRef.current.moveTo(x, y);
    contextRef.current.strokeStyle = activeTool === 'eraser' ? 'white' : activeColor;
    contextRef.current.lineWidth = activeTool === 'eraser' ? brushSize * 2.5 : brushSize;
    contextRef.current.lineTo(x, y); contextRef.current.stroke();
  };

  const draw = (e) => { if (!isDrawing.current) return; const rect = canvasRef.current.getBoundingClientRect(); const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left; const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top; contextRef.current.lineTo(x, y); contextRef.current.stroke(); };
  const stopDrawing = () => { isDrawing.current = false; contextRef.current?.closePath(); };
  const clearCanvas = () => { contextRef.current.fillStyle = 'white'; contextRef.current.fillRect(0, 0, canvasRef.current.width, canvasRef.current.height); };

  // --- RENDERS ---
  const renderMagicSketch = () => (
    <div className="min-h-screen bg-[#F0F7FF] font-['Fredoka_One',_cursive] pb-20">
      <header className="bg-white p-4 shadow-sm flex items-center justify-between sticky top-0 z-50">
        <div className="flex items-center gap-4"><button onClick={() => setView('menu')} className="p-2 hover:bg-gray-100 rounded-full transition-colors"><ChevronLeft size={28} className="text-gray-400" /></button><h1 className="text-2xl font-black text-[#1982C4]">Magic Sketch</h1></div>
        <button onClick={clearCanvas} className="bg-red-50 text-red-500 px-5 py-2 rounded-full font-bold transition-all text-sm flex items-center gap-2"><RotateCcw size={18} /> Bersihkan</button>
      </header>
      <div className="max-w-6xl mx-auto p-4 md:p-8 space-y-12 animate-in fade-in">
        <section className="flex flex-col md:flex-row gap-6 items-start">
          <div className="bg-white p-4 rounded-3xl shadow-lg flex md:flex-col gap-4 w-full md:w-auto"><button onClick={() => setActiveTool('pencil')} className={`w-14 h-14 rounded-2xl flex items-center justify-center transition-all ${activeTool === 'pencil' ? 'bg-[#1982C4] text-white scale-110 shadow-lg' : 'bg-gray-100 text-gray-400'}`}><Pencil size={28} /></button><button onClick={() => setActiveTool('eraser')} className={`w-14 h-14 rounded-2xl flex items-center justify-center transition-all ${activeTool === 'eraser' ? 'bg-[#FF595E] text-white scale-110 shadow-lg' : 'bg-gray-100 text-gray-400'}`}><Eraser size={28} /></button><div className="h-[2px] bg-gray-100 w-full" /><div className="grid grid-cols-4 md:grid-cols-2 gap-2">{COLORS.map(c => <button key={c} onClick={() => { setActiveColor(c); setActiveTool('pencil'); }} className={`w-10 h-10 rounded-full border-4 transition-transform ${activeColor === c && activeTool === 'pencil' ? 'border-white ring-2 ring-blue-200' : 'border-transparent'}`} style={{ backgroundColor: c }} />)}</div></div>
          <div className="flex-1 w-full flex flex-col gap-4"><div className="bg-white rounded-[2.5rem] shadow-2xl overflow-hidden border-8 border-white ring-8 ring-blue-100/30 w-full aspect-video"><canvas ref={canvasRef} onMouseDown={startDrawing} onMouseMove={draw} onMouseUp={stopDrawing} onMouseLeave={stopDrawing} onTouchStart={startDrawing} onTouchMove={draw} onTouchEnd={stopDrawing} className="w-full h-full touch-none cursor-crosshair" /></div><div className="bg-white px-8 py-4 rounded-3xl shadow-sm flex items-center gap-6"><span className="font-bold text-gray-400 text-sm uppercase">Kuas:</span><input type="range" min="2" max="50" value={brushSize} onChange={(e) => setBrushSize(parseInt(e.target.value))} className="flex-1 accent-[#1982C4]" /></div></div>
        </section>
        <section className="bg-white rounded-[3rem] p-8 shadow-xl border-4 border-white text-center"><h3 className="text-3xl font-black text-[#2D3142] mb-8">Sihir Lukisan âœ¨</h3><div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-10">{PRESETS_SKETCH.map(p => <button key={p.id} onClick={() => setSelectedSketchPreset(p)} className={`p-6 rounded-3xl border-4 flex flex-col items-center gap-3 transition-all ${selectedSketchPreset.id === p.id ? 'border-[#1982C4] bg-blue-50 scale-105 shadow-md' : 'border-gray-50 hover:border-gray-200'}`}><span className="text-4xl">{p.icon}</span><span className="font-bold">{p.name}</span></button>)}</div><button onClick={handleStartSketchMagic} disabled={isProcessingSketch} className={`px-16 py-6 bg-[#1982C4] text-white rounded-[2rem] font-black text-2xl shadow-xl flex items-center gap-3 mx-auto transition-all ${isProcessingSketch ? 'opacity-70 scale-95' : 'hover:scale-105 active:scale-95'}`}>{isProcessingSketch ? <Loader2 className="animate-spin" size={32} /> : <Sparkles size={32} />}{isProcessingSketch ? 'MENYULAP...' : 'SULAP GAMBAR!'}</button></section>
        {isProcessingSketch && (<div className="bg-white rounded-[3rem] p-10 shadow-lg animate-pulse text-center"><div className="w-full aspect-video bg-gray-100 rounded-[2.5rem] flex items-center justify-center"><ImageIcon size={80} className="text-gray-200" /></div></div>)}
        {sketchResult && (
          <section className="bg-yellow-400 rounded-[3rem] p-1 shadow-2xl animate-in zoom-in"><div className="bg-white rounded-[2.9rem] p-10 flex flex-col lg:flex-row gap-10"><div className="flex-1 relative group rounded-[2.5rem] overflow-hidden border-4 border-gray-100 cursor-pointer" onClick={() => { setModalImage(sketchResult); setModalType('sketch'); setShowModal(true); }}><img src={sketchResult} className="w-full h-full object-cover" alt="Hasil" /><div className="absolute inset-0 bg-black/10 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center"><Maximize2 size={48} className="text-white drop-shadow-lg" /></div></div><div className="lg:w-72 space-y-6 flex flex-col items-center"><div className="w-full bg-blue-50 p-4 rounded-2xl border-4 border-white shadow-inner"><p className="text-[#1982C4] font-bold text-xs uppercase mb-2">Sketsa Asli:</p><img src={canvasRef.current?.toDataURL()} className="w-full rounded-xl bg-white border" alt="Original" /></div><button onClick={() => downloadMagicResultWithSnapshot(sketchResult, canvasRef.current?.toDataURL())} className="w-full py-5 bg-[#8AC926] text-white rounded-2xl font-black text-xl flex items-center justify-center gap-3 shadow-lg hover:brightness-95"><Download size={24} /> SIMPAN</button></div></div></section>
        )}
      </div>
    </div>
  );

  const renderIfIBecomes = () => (
    <div className="min-h-screen bg-[#FDF0F3] font-['Fredoka_One',_cursive] pb-20">
      <header className="bg-white p-4 shadow-sm flex items-center justify-between sticky top-0 z-50"><div className="flex items-center gap-4"><button onClick={() => setView('menu')} className="p-2 hover:bg-gray-100 rounded-full transition-colors"><ChevronLeft size={28} className="text-gray-400" /></button><h1 className="text-2xl font-black text-[#FF595E]">If I Becomes</h1></div><div className="w-10 h-10 bg-[#FF595E] rounded-xl flex items-center justify-center shadow-lg"><Briefcase className="text-white v-6 h-6" /></div></header>
      <div className="max-w-5xl mx-auto p-6 md:p-10 space-y-12">
        <section className="bg-white rounded-[3rem] p-8 shadow-lg border-4 border-white text-center"><h3 className="text-3xl font-black text-[#2D3142] mb-6">1. Upload Fotomu ğŸ“¸</h3>{!uploadedPhoto ? (<label className="flex flex-col items-center justify-center border-4 border-dashed border-red-100 bg-red-50 rounded-[2.5rem] p-12 cursor-pointer hover:bg-red-100 transition-colors group"><Upload size={48} className="text-[#FF595E] mb-4" /><span className="text-xl font-bold text-red-400">Pilih Foto Anak</span><input type="file" className="hidden" accept="image/*" onChange={(e) => handleFileUpload(e, 'job')} /></label>) : (<div className="relative w-64 mx-auto rounded-[2.5rem] overflow-hidden border-8 border-white shadow-xl group"><img src={uploadedPhoto} className="w-full aspect-[3/4] object-cover" alt="Upload" /><button onClick={() => setUploadedPhoto(null)} className="absolute top-4 right-4 bg-white/90 p-2 rounded-full text-red-500 shadow-lg hover:bg-red-50 transition-colors opacity-0 group-hover:opacity-100"><X size={20} /></button></div>)}</section>
        <section className="bg-white rounded-[3rem] p-8 shadow-lg border-4 border-white flex flex-col md:flex-row items-center justify-between gap-6"><div><h3 className="text-2xl font-black text-[#2D3142] mb-1 flex items-center gap-2"><Timer className="text-[#FF595E]" /> Prediksi Masa Depan?</h3><p className="text-gray-400 text-sm">Lihat dirimu saat sudah dewasa!</p></div><button onClick={() => setIsFuturePrediction(!isFuturePrediction)} className={`relative w-20 h-10 rounded-full p-1 transition-colors ${isFuturePrediction ? 'bg-[#FF595E]' : 'bg-gray-200'}`}><div className={`w-8 h-8 bg-white rounded-full shadow-lg transform transition-transform ${isFuturePrediction ? 'translate-x-10' : 'translate-x-0'} flex items-center justify-center`}>{isFuturePrediction ? <Sparkles size={16} className="text-[#FF595E]" /> : <Baby size={16} className="text-gray-400" />}</div></button></section>
        <section className="bg-white rounded-[3rem] p-8 shadow-lg border-4 border-white"><h3 className="text-3xl font-black text-[#2D3142] mb-8 text-center">3. Pilih Cita-cita ğŸŒŸ</h3><div className="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-8">{JOBS.map(job => <button key={job.id} onClick={() => { setSelectedJob(job); setCustomJob(""); }} className={`p-6 rounded-3xl border-4 flex flex-col items-center gap-3 transition-all ${selectedJob.id === job.id && !customJob ? 'border-[#FF595E] bg-red-50' : 'border-gray-50'}`}><span className="text-4xl">{job.icon}</span><span className="font-bold">{job.name}</span></button>)}</div><input type="text" placeholder="Tulis cita-citamu sendiri..." value={customJob} onChange={(e) => setCustomJob(e.target.value)} className="w-full px-6 py-4 bg-gray-50 border-2 rounded-2xl outline-none font-bold" /></section>
        <div className="flex justify-center"><button onClick={generateJobImages} disabled={!uploadedPhoto || isProcessingJobs} className={`px-16 py-7 rounded-[2.5rem] bg-[#FF595E] text-white font-black text-3xl shadow-xl flex items-center gap-3 transition-all ${isProcessingJobs ? 'opacity-70 scale-95 cursor-not-allowed' : 'hover:scale-105 active:scale-95'}`}>{isProcessingJobs ? <Loader2 className="animate-spin" size={32} /> : <Sparkles size={32} />}{isProcessingJobs ? 'SULAP...' : 'SULAP!'}</button></div>
        <div className="mt-12 grid grid-cols-1 sm:grid-cols-2 gap-8">{isProcessingJobs ? Array(4).fill(0).map((_, i) => (<div key={i} className="bg-white p-4 rounded-[3rem] shadow-xl animate-pulse"><div className="aspect-[3/4] rounded-[2.2rem] bg-gray-100 flex items-center justify-center"><ImageIcon size={48} className="text-gray-200" /></div></div>)) : jobResults.map((img, idx) => (<div key={idx} className="bg-white p-4 rounded-[3rem] shadow-xl border-4 border-white overflow-hidden cursor-pointer" onClick={() => { setModalImage(img); setModalType('job'); setCurrentStoryIdx(idx); setShowModal(true); }}><div className="aspect-[3/4] rounded-[2.2rem] overflow-hidden"><img src={img} className="w-full h-full object-cover" alt="Result" /></div><div className="mt-4 flex justify-between items-center px-4"><span className="text-[#FF595E] font-black">Variasi {idx + 1}</span><button onClick={(e) => {e.stopPropagation(); download34Portrait(img, "CitaCita", idx);}} className="p-3 bg-red-50 text-[#FF595E] rounded-2xl hover:bg-[#FF595E] hover:text-white transition-colors"><Download size={20} /></button></div></div>))}</div>
      </div>
    </div>
  );

  const renderStoryMaker = () => (
    <div className="min-h-screen bg-[#F0FAF0] font-['Fredoka_One',_cursive] pb-20">
      <header className="bg-white p-4 shadow-sm flex items-center justify-between sticky top-0 z-50">
        <div className="flex items-center gap-4"><button onClick={() => setView('menu')} className="p-2 hover:bg-gray-100 rounded-full transition-colors"><ChevronLeft size={28} className="text-gray-400" /></button><h1 className="text-2xl font-black text-[#8AC926]">Story Maker</h1></div>
        <div className="w-10 h-10 bg-[#8AC926] rounded-xl flex items-center justify-center shadow-lg"><BookOpen className="text-white w-6 h-6" /></div>
      </header>
      <div className="max-w-4xl mx-auto p-6 md:p-10 space-y-10">
        <section className="bg-white rounded-[3rem] p-10 shadow-lg border-4 border-white text-center">
          <h2 className="text-3xl font-black text-[#2D3142] mb-6 flex items-center justify-center gap-3"><Sparkles className="text-[#8AC926]" /> Rancang Ceritamu</h2>
          <div className="space-y-8 max-w-2xl mx-auto">
            <div className="space-y-4"><label className="text-xs font-black text-gray-400 uppercase tracking-widest flex items-center justify-center gap-2"><Languages size={14} /> Bahasa Cerita</label>
              <div className="flex justify-center gap-4">
                <button onClick={() => setStoryLanguage('id')} className={`px-6 py-3 rounded-2xl font-black transition-all ${storyLanguage === 'id' ? 'bg-[#8AC926] text-white shadow-lg' : 'bg-gray-50 text-gray-400'}`}>ğŸ‡®ğŸ‡© Indonesia</button>
                <button onClick={() => setStoryLanguage('en')} className={`px-6 py-3 rounded-2xl font-black transition-all ${storyLanguage === 'en' ? 'bg-[#8AC926] text-white shadow-lg' : 'bg-gray-50 text-gray-400'}`}>ğŸ‡ºğŸ‡¸ English</button>
              </div>
            </div>
            <div className="space-y-4"><label className="text-xs font-black text-gray-400 uppercase tracking-widest flex items-center justify-center gap-2"><Camera size={14} /> Tokoh Utama</label>
              {!storyPhoto ? (<label className="flex flex-col items-center justify-center border-4 border-dashed border-green-100 bg-green-50 rounded-3xl p-8 cursor-pointer hover:bg-green-100 transition-colors"><Upload size={32} className="text-[#8AC926] mb-2" /><span className="text-xs font-bold text-green-400">Pilih Foto Anak</span><input type="file" className="hidden" accept="image/*" onChange={(e) => handleFileUpload(e, 'story')} /></label>) : (<div className="relative w-32 mx-auto rounded-2xl overflow-hidden border-4 border-white shadow-lg group"><img src={storyPhoto} className="w-full aspect-square object-cover" alt="Anak" /><button onClick={() => setStoryPhoto(null)} className="absolute top-1 right-1 bg-white/90 p-1 rounded-full text-red-500 shadow-lg opacity-0 group-hover:opacity-100"><X size={14} /></button></div>)}
            </div>
            <textarea value={storyIdea} onChange={(e) => setStoryIdea(e.target.value)} placeholder="Misal: Petualangan kucing lucu di bulan..." className="w-full h-32 p-6 bg-gray-50 border-4 border-green-50 rounded-3xl focus:border-[#8AC926] outline-none font-bold text-lg resize-none" />
            <button onClick={createStory} disabled={!storyIdea.trim() || isProcessingStory} className={`w-full py-6 rounded-[2rem] font-black text-2xl flex items-center justify-center gap-4 shadow-xl transition-all ${!storyIdea.trim() || isProcessingStory ? 'bg-gray-200 text-gray-400' : 'bg-[#8AC926] text-white hover:scale-105 active:scale-95'}`}>{isProcessingStory ? <Loader2 className="animate-spin" size={28} /> : <Send size={24} />}{isProcessingStory ? 'SEDANG MENULIS...' : 'MULAI SIHIR!'}</button>
          </div>
        </section>
        {isProcessingStory && (<div className="bg-white rounded-[3rem] p-10 shadow-lg border-4 border-white text-center space-y-4"><h4 className="text-xl font-black text-[#2D3142]">Buku sedang dibuat... âœ¨</h4><div className="w-full bg-gray-100 h-3 rounded-full overflow-hidden"><div className="h-full bg-[#8AC926] transition-all duration-500" style={{ width: `${(storyPages.length / 12) * 100}%` }} /></div><p className="text-xs font-bold text-gray-400 uppercase">Halaman {storyPages.length} dari 12</p></div>)}
        {storyPages.length > 0 && (<section className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">{storyPages.map((page, idx) => (<div key={idx} className="group bg-white p-3 rounded-[2rem] shadow-xl border-4 border-white cursor-pointer" onClick={() => { setCurrentStoryIdx(idx); setModalImage(page.image); setModalType('story'); setShowModal(true); }}><div className="aspect-video rounded-[1.5rem] overflow-hidden"><img src={page.image} className="w-full h-full object-cover transition-transform group-hover:scale-110" alt={`Page ${idx+1}`} /></div><div className="mt-3 text-center"><span className="font-black text-[#8AC926]">Halaman {idx + 1}</span></div></div>))}</section>)}
      </div>
    </div>
  );

  const renderLearnTheThing = () => (
    <div className="min-h-screen bg-[#F5F3FF] font-['Fredoka_One',_cursive] pb-20">
      <header className="bg-white p-4 shadow-sm flex items-center justify-between sticky top-0 z-50"><div className="flex items-center gap-4"><button onClick={() => setView('menu')} className="p-2 hover:bg-gray-100 rounded-full transition-colors"><ChevronLeft size={28} className="text-gray-400" /></button><h1 className="text-2xl font-black text-[#9B5DE5]">Learn The Thing</h1></div><div className="w-10 h-10 bg-[#9B5DE5] rounded-xl flex items-center justify-center shadow-lg"><Type className="text-white w-6 h-6" /></div></header>
      <div className="max-w-7xl mx-auto p-6 md:p-10">
        {learnStep === 'setup' ? (
          <div className="max-w-4xl mx-auto text-center space-y-10 py-6 animate-in zoom-in">
            <div className="space-y-4"><h2 className="text-5xl font-black text-[#2D3142]">Ayo Belajar! ğŸ’</h2><p className="text-gray-400 text-xl">Pilih petualangan belajarmu hari ini</p></div>
            <div className="bg-white p-8 rounded-[3.5rem] shadow-xl border-4 border-white space-y-8">
              <div className="flex justify-center gap-4">
                <button onClick={() => setLearnMode('theme')} className={`flex-1 py-4 rounded-2xl font-black transition-all border-4 ${learnMode === 'theme' ? 'bg-purple-100 text-[#9B5DE5] border-[#9B5DE5]' : 'bg-gray-50 text-gray-400 border-transparent'}`}>Berdasarkan Tema</button>
                <button onClick={() => setLearnMode('alphabet')} className={`flex-1 py-4 rounded-2xl font-black transition-all border-4 ${learnMode === 'alphabet' ? 'bg-purple-100 text-[#9B5DE5] border-[#9B5DE5]' : 'bg-gray-50 text-gray-400 border-transparent'}`}>Per Huruf Alfabet</button>
              </div>
              {learnMode === 'theme' ? (
                <div className="space-y-6">
                  <div className="grid grid-cols-2 gap-4">{LEARN_THEMES.map(theme => (<button key={theme.id} onClick={() => { setSelectedLearnTheme(theme); setCustomLearnTheme(""); }} className={`p-4 rounded-3xl border-4 transition-all flex flex-col items-center gap-2 ${selectedLearnTheme.id === theme.id && !customLearnTheme ? 'border-[#9B5DE5] bg-purple-50' : 'border-gray-50 opacity-60'}`}><div className={`w-12 h-12 rounded-xl flex items-center justify-center ${theme.color} ${theme.bg}`}>{React.cloneElement(theme.icon, { size: 24 })}</div><span className={`font-black ${theme.color}`}>{theme.name}</span></button>))}</div>
                  <input type="text" placeholder="Atau tema sendiri: Robot, Dinosaurus..." value={customLearnTheme} onChange={(e) => setCustomLearnTheme(e.target.value)} className="w-full px-6 py-4 bg-gray-50 border-4 border-purple-50 rounded-[2rem] outline-none font-bold focus:border-[#9B5DE5] text-lg transition-all" />
                </div>
              ) : (<div className="grid grid-cols-6 sm:grid-cols-9 gap-2">{ALPHABET_LIST.map(char => (<button key={char} onClick={() => setSelectedLearnLetter(char)} className={`w-10 h-10 rounded-xl font-black text-lg flex items-center justify-center transition-all ${selectedLearnLetter === char ? 'bg-[#9B5DE5] text-white scale-110 shadow-md' : 'bg-gray-50 text-gray-300'}`}>{char}</button>))}</div>)}
            </div>
            <button onClick={startLearnTheThing} className="px-20 py-8 bg-[#9B5DE5] text-white rounded-[2.5rem] font-black text-3xl shadow-2xl hover:scale-105 active:scale-95 flex items-center gap-4 mx-auto"><Sparkles size={32} /> MULAI!</button>
          </div>
        ) : (
          <div className="space-y-10 animate-in fade-in">
            <div className="bg-white rounded-[3rem] p-8 shadow-xl border-4 border-white flex flex-col md:flex-row items-center justify-between gap-6"><div className="flex items-center gap-4"><div className="w-16 h-16 rounded-2xl flex items-center justify-center bg-purple-50 text-[#9B5DE5]">{learnMode === 'theme' ? <Tags size={32} /> : <span className="text-3xl font-black">{selectedLearnLetter}</span>}</div><h3 className="text-2xl font-black text-[#2D3142]">Materi: {learnMode === 'theme' ? (customLearnTheme || selectedLearnTheme.name) : `Huruf ${selectedLearnLetter}`}</h3></div><button onClick={() => setLearnStep('setup')} className="px-6 py-3 bg-gray-100 text-gray-500 rounded-2xl font-bold hover:bg-gray-200">Ganti Materi</button></div>
            <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-6">{learnItems.map((item, idx) => (<button key={idx} onClick={() => { if (item.imageUrl) { setSelectedLetterItem(item); setCurrentStoryIdx(idx); setModalImage(item.imageUrl); setModalType('learn'); setShowModal(true); } }} disabled={!item.imageUrl} className={`group relative aspect-[3/4] rounded-[2.5rem] p-4 shadow-xl transition-all flex flex-col border-4 border-white bg-white ${!item.imageUrl ? 'opacity-50 grayscale' : 'hover:-translate-y-2'}`}><span className="text-4xl font-black text-gray-200 absolute top-2 left-3">{item.char}</span><div className="flex-1 flex items-center justify-center w-full">{item.imageUrl ? (<img src={item.imageUrl} className="w-full h-full object-cover rounded-2xl transform group-hover:scale-110 transition-transform" alt={item.word} />) : (<Loader2 className="animate-spin text-gray-300" size={40} />)}</div><div className="text-center w-full bg-purple-50 rounded-2xl py-2 mt-2"><span className="text-lg font-black block text-[#9B5DE5] leading-none uppercase">{item.imageUrl ? item.word : '...'}</span></div></button>))}</div>
          </div>
        )}
      </div>
    </div>
  );

  const renderSoundExplorer = () => (
    <div className="min-h-screen bg-[#E0F7FA] font-['Fredoka_One',_cursive] pb-20">
      <header className="bg-white p-4 shadow-sm flex items-center justify-between sticky top-0 z-50"><div className="flex items-center gap-4"><button onClick={() => setView('menu')} className="p-2 hover:bg-gray-100 rounded-full transition-colors"><ChevronLeft size={28} className="text-gray-400" /></button><h1 className="text-2xl font-black text-[#00BBF9]">Sound Explorer</h1></div><div className="w-10 h-10 bg-[#00BBF9] rounded-xl flex items-center justify-center shadow-lg"><Speaker className="text-white w-6 h-6" /></div></header>
      <div className="max-w-7xl mx-auto p-6 md:p-10">
        {soundStep === 'setup' ? (
          <div className="max-w-3xl mx-auto text-center space-y-10 py-10 animate-in zoom-in">
            <div className="space-y-4"><h2 className="text-5xl font-black text-[#2D3142]">Dunia Suara! ğŸ”Š</h2><p className="text-gray-400 text-xl">Dunia suara apa yang ingin kamu dengar?</p></div>
            <div className="grid grid-cols-2 gap-6">{SOUND_THEMES.map(theme => (<button key={theme.id} onClick={() => { setSelectedSoundTheme(theme); setCustomSoundTheme(""); }} className={`p-8 rounded-[3rem] border-8 transition-all flex flex-col items-center gap-4 shadow-xl hover:scale-105 ${selectedSoundTheme.id === theme.id && !customSoundTheme ? 'border-[#00BBF9] bg-white' : 'border-transparent bg-white/50 opacity-60'}`}><div className={`w-16 h-16 rounded-3xl flex items-center justify-center ${theme.color} ${theme.bg}`}>{React.cloneElement(theme.icon, { size: 32 })}</div><span className={`text-xl font-black ${theme.color}`}>{theme.name}</span></button>))}</div>
            <input type="text" placeholder="Atau tema suaramu sendiri..." value={customSoundTheme} onChange={(e) => setCustomSoundTheme(e.target.value)} className="w-full px-8 py-5 bg-white border-4 border-cyan-100 rounded-[2rem] outline-none font-bold focus:border-[#00BBF9] text-xl transition-all" />
            <button onClick={startSoundExplorer} className="px-20 py-8 bg-[#00BBF9] text-white rounded-[2.5rem] font-black text-3xl shadow-2xl hover:scale-105 active:scale-95 flex items-center gap-4 mx-auto"><Mic2 size={32} /> MULAI!</button>
          </div>
        ) : (
          <div className="space-y-10 animate-in fade-in">
            <div className="bg-white rounded-[3rem] p-8 shadow-xl border-4 border-white flex flex-col md:flex-row items-center justify-between gap-6"><div className="flex items-center gap-4"><div className="w-16 h-16 rounded-2xl flex items-center justify-center bg-cyan-50 text-[#00BBF9]"><Speaker size={32} /></div><h3 className="text-2xl font-black text-[#2D3142]">Materi: {customSoundTheme || selectedSoundTheme.name}</h3></div><button onClick={() => setSoundStep('setup')} className="px-6 py-3 bg-gray-100 text-gray-500 rounded-2xl font-bold hover:bg-gray-200">Ganti Tema</button></div>
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8 pb-20">{soundItems.map((item, idx) => (<button key={idx} onClick={() => { if (item.imageUrl) { setSelectedSoundItem(item); setCurrentStoryIdx(idx); setModalImage(item.imageUrl); setModalType('sound'); setShowModal(true); } }} disabled={!item.imageUrl} className={`group relative aspect-[3/4] rounded-[3.5rem] p-4 shadow-xl transition-all flex flex-col border-4 border-white bg-white ${!item.imageUrl ? 'opacity-50' : 'hover:-translate-y-2'}`}><div className="flex-1 flex items-center justify-center w-full">{item.imageUrl ? (<img src={item.imageUrl} className="w-full h-full object-cover rounded-[2.5rem] transform group-hover:scale-110 transition-transform" alt={item.name} />) : (<Loader2 className="animate-spin text-gray-300" size={60} />)}</div><div className="text-center w-full bg-cyan-50 rounded-3xl py-4 mt-4 uppercase"><span className="text-xl font-black block text-[#00BBF9] tracking-wider">{item.imageUrl ? item.name : '...'}</span></div></button>))}</div>
          </div>
        )}
      </div>
    </div>
  );

  return (
    <div className="min-h-screen">
      {view === 'menu' && <MainMenu setView={setView} />}
      {view === 'sketch' && renderMagicSketch()}
      {view === 'ifibecomes' && renderIfIBecomes()}
      {view === 'story' && renderStoryMaker()}
      {view === 'printable' && renderPrintableSketch()}
      {view === 'learn' && renderLearnTheThing()}
      {view === 'sound' && renderSoundExplorer()}

      {/* Global Modal View */}
      {showModal && (
        <div className="fixed inset-0 z-[100] bg-black/95 backdrop-blur-md flex items-center justify-center p-4">
          <div className="relative w-full max-w-5xl bg-white p-4 rounded-[2.5rem] shadow-2xl animate-in zoom-in duration-300">
            <button onClick={() => { setShowModal(false); stopCurrentAudio(); }} className="absolute -top-4 -right-4 bg-white text-slate-800 p-3 rounded-full shadow-2xl hover:bg-red-50 transition-colors border-2 border-slate-100 z-[110]"><X size={28} strokeWidth={3} /></button>
            <div className={`rounded-[2rem] overflow-hidden shadow-inner bg-slate-50 relative flex items-center justify-center ${
                (modalType === 'job' || modalType === 'learn' || modalType === 'sound') ? 'aspect-[3/4] max-h-[80vh] mx-auto' : 
                (modalType === 'printable') ? 'aspect-[1.414/1] max-h-[65vh] mx-auto' : 
                'aspect-video max-h-[80vh]'
            }`}>
              <img src={modalImage} className={`w-full h-full ${modalType === 'job' ? 'object-cover' : 'object-contain'}`} alt="Fullscreen" />
              {(modalType === 'learn' || modalType === 'sound' || modalType === 'story' || modalType === 'job') && (
                <>
                  {currentStoryIdx > 0 && (<button onClick={() => { 
                    const n = currentStoryIdx - 1; 
                    const items = modalType === 'learn' ? learnItems : modalType === 'sound' ? soundItems : modalType === 'job' ? jobResults : storyPages;
                    if (items[n]) {
                      setCurrentStoryIdx(n); 
                      setModalImage(modalType === 'story' ? items[n].image : (modalType === 'job' ? items[n] : items[n].imageUrl)); 
                      if(modalType === 'learn') setSelectedLetterItem(items[n]); 
                      else if(modalType === 'sound') setSelectedSoundItem(items[n]); 
                    }
                    stopCurrentAudio();
                  }} className="absolute left-6 top-1/2 -translate-y-1/2 bg-white/80 p-4 rounded-full shadow-xl hover:bg-white text-slate-800"><ChevronLeft size={32} strokeWidth={3} /></button>)}
                  {currentStoryIdx < (modalType === 'learn' ? learnItems.length : (modalType === 'sound' ? soundItems.length : (modalType === 'job' ? jobResults.length : storyPages.length))) - 1 && (<button onClick={() => { 
                    const n = currentStoryIdx + 1; 
                    const items = modalType === 'learn' ? learnItems : modalType === 'sound' ? soundItems : modalType === 'job' ? jobResults : storyPages;
                    if (items[n]) {
                      setCurrentStoryIdx(n); 
                      setModalImage(modalType === 'story' ? items[n].image : (modalType === 'job' ? items[n] : items[n].imageUrl)); 
                      if(modalType === 'learn') setSelectedLetterItem(items[n]); 
                      else if(modalType === 'sound') setSelectedSoundItem(items[n]); 
                    }
                    stopCurrentAudio();
                  }} className="absolute right-6 top-1/2 -translate-y-1/2 bg-white/80 p-4 rounded-full shadow-xl hover:bg-white text-slate-800"><ChevronRight size={32} strokeWidth={3} /></button>)}
                </>
              )}
            </div>
            <div className="mt-6 flex justify-between items-center px-4">
              <div className="flex items-center gap-2"><Heart className="text-red-500 fill-red-500" /><span className="text-xl font-black text-slate-800 uppercase tracking-wide">
                {modalType === 'story' ? `Buku Ceritaku - Hal ${currentStoryIdx + 1}` : 
                 modalType === 'printable' ? 'Sketsa Mewarnai A4' : 
                 modalType === 'learn' ? `Flashcard ${selectedLetterItem?.word}` : 
                 modalType === 'sound' ? `Suara ${selectedSoundItem?.name}` : 
                 modalType === 'job' ? `Prediksi - Variasi ${currentStoryIdx + 1}` :
                 'KidsZone Lab'}
              </span></div>
              <div className="flex gap-4">
                {(modalType === 'learn' || modalType === 'sound' || modalType === 'story' || (modalType === 'sketch' && sketchNarration)) && (
                  <button 
                    onClick={() => { 
                      const key = modalType === 'sketch' ? 'magic_sketch' : (modalType === 'learn' ? `learn_${currentStoryIdx}` : (modalType === 'sound' ? `sound_${currentStoryIdx}` : `story_${currentStoryIdx}`));
                      const text = modalType === 'sketch' ? sketchNarration : (modalType === 'learn' ? `${selectedLetterItem?.char} untuk ${selectedLetterItem?.word}` : (modalType === 'sound' ? `${selectedSoundItem?.onomatopoeia}, suara ${selectedSoundItem?.name}` : storyPages[currentStoryIdx]?.text));
                      const lang = modalType === 'story' ? storyLanguage : (modalType === 'learn' ? learnLanguage : 'id');
                      playAudio(text, key, lang);
                    }} 
                    className={`text-white px-8 py-3 rounded-2xl font-bold flex items-center gap-2 shadow-lg transition-all ${isSpeaking ? 'bg-red-500' : 'bg-[#1982C4]'}`}
                  >
                    {isSpeaking ? <Square size={24} /> : <Volume2 size={24} />} 
                    {isSpeaking ? 'Stop' : 'Dengar'}
                  </button>
                )}
                <button onClick={() => { setShowModal(false); stopCurrentAudio(); }} className="bg-slate-100 text-slate-500 px-8 py-3 rounded-2xl font-bold">Tutup</button>
                <button onClick={() => { if (modalType === 'job') download34Portrait(modalImage, "CitaCita", currentStoryIdx); else if (modalType === 'printable') downloadA4Printable(modalImage); else if (modalType === 'learn') download34Portrait(modalImage, `Flashcard_${selectedLetterItem?.word}`, 0); else if (modalType === 'sound') download34Portrait(modalImage, `Suara_${selectedSoundItem?.name}`, 0); else if (modalType === 'story') handleDownloadSimple(modalImage, `Cerita_Hal_${currentStoryIdx + 1}.png`); else if (modalType === 'sketch') downloadMagicResultWithSnapshot(modalImage, canvasRef.current?.toDataURL()); }} className="bg-[#8AC926] text-white px-8 py-3 rounded-2xl font-black flex items-center gap-2 shadow-lg hover:brightness-95"><Download size={20} /> Simpan</button>
              </div>
            </div>
          </div>
        </div>
      )}
      {error && (<div className="fixed bottom-10 left-1/2 -translate-x-1/2 z-[110] bg-red-500 text-white px-10 py-5 rounded-full shadow-2xl flex items-center gap-4 animate-bounce border-4 border-white"><p className="font-black text-lg">{error}</p><button onClick={() => setError(null)} className="p-2 hover:bg-white/20 rounded-full"><X size={24} /></button></div>)}
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap');
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        input[type='range'] { -webkit-appearance: none; background: #e2e8f0; height: 12px; border-radius: 10px; }
        input[type='range']::-webkit-slider-thumb { -webkit-appearance: none; width: 24px; height: 24px; background: #1982C4; border-radius: 50%; cursor: pointer; border: 4px solid white; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
      `}</style>
    </div>
  );
};

export default App;
